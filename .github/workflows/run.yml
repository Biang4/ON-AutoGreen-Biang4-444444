# å®šä¹‰ GitHub Actions å·¥ä½œæµçš„åç§°
name: 180 Cloud check in action

# å®šä¹‰è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main
  # å½“ç”¨æˆ·å¯¹ä»“åº“è¿›è¡Œ watch æ“ä½œæ—¶è§¦å‘
  watch:
    types: started
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  # å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©åŒ—äº¬æ—¶é—´ 14 ç‚¹ 10 åˆ†è§¦å‘ï¼ˆå¯¹åº” UTC æ—¶é—´ 06 ç‚¹ 10 åˆ†ï¼‰
  schedule:
    - cron: 20 06 * * *

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  # å®šä¹‰åä¸º build-and-deploy çš„ä½œä¸š
  build-and-deploy:
    # æŒ‡å®šä½œä¸šè¿è¡Œçš„ç¯å¢ƒï¼Œè¿™é‡Œä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-latest
    # æŒ‡å®šä½œä¸šè¿è¡Œæ—¶ä½¿ç”¨çš„ç¯å¢ƒå˜é‡
    environment: user
    # å®šä¹‰ä½œä¸šä¸­çš„æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: éšæœºå»¶è¿Ÿ 0 - 3 åˆ†é’Ÿï¼Œé¿å…é›†ä¸­è¯·æ±‚æœåŠ¡å™¨
      - name: ğŸ”€ éšæœºå»¶è¿Ÿ 0 - 3 åˆ†é’Ÿ
        run: |
          delay=$((RANDOM % 181))
          echo "å°†å»¶è¿Ÿ $delay ç§’åç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤..."
          sleep $delay
          echo "å»¶è¿Ÿ $delay ç§’å·²å®Œæˆï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ã€‚"

      # æ­¥éª¤ 2: æ£€å‡ºä»£ç åˆ°è¿è¡Œç¯å¢ƒ
      - name: ğŸ”Œ æ£€å‡ºä»£ç 
        uses: actions/checkout@main

      # æ­¥éª¤ 3: è®¾ç½® Node.js ç¯å¢ƒï¼Œä½¿ç”¨ç‰ˆæœ¬ 18 å¹¶å¯ç”¨ npm ç¼“å­˜
      - name: ğŸ”¨ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@main
        with:
          node-version: 18
          cache: npm

      # æ­¥éª¤ 4: æ£€æŸ¥æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œå¦‚æœå¼€å¯åˆ™è®¾ç½®ç¯å¢ƒå˜é‡
      - name: ğŸ‘¾ æ£€æŸ¥æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼
        if: vars.debug == '1'
        run: |
          echo "è°ƒè¯•æ¨¡å¼å·²å¼€å¯ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ CLOUD189_VERBOSE=1"
          echo "CLOUD189_VERBOSE=1" >> $GITHUB_ENV

      # æ­¥éª¤ 5: æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜ Tokenï¼Œå¦‚æœå¯ç”¨åˆ™è®¾ç½®ç¯å¢ƒå˜é‡
      - name: ğŸ—³ï¸ æ£€æŸ¥æ˜¯å¦å¯ç”¨ç¼“å­˜ Token
        if: vars.cacheToken == '1'
        run: |
          echo "å¯ç”¨ç¼“å­˜ Tokenï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ CACHE_TOKEN=1"
          echo "CACHE_TOKEN=1" >> $GITHUB_ENV

      # æ­¥éª¤ 6: æ¢å¤ç¼“å­˜çš„ Cookieï¼Œå¦‚æœå¯ç”¨äº†ç¼“å­˜ Token
      - name: ğŸ“¹ æ¢å¤ç¼“å­˜çš„ Cookie
        id: cache-cookie-restore
        if: vars.cacheToken == '1'
        uses: actions/cache@v4
        with:
          path: .token
          key: ${{ runner.os }}-cache-token

      # æ­¥éª¤ 7: åˆå§‹åŒ–æœºå¯†ä¿¡æ¯ï¼Œå°†ä»“åº“çš„ secrets è½¬æ¢ä¸ºç¯å¢ƒå˜é‡
      - name: ğŸ”§ åˆå§‹åŒ–æœºå¯†ä¿¡æ¯
        uses: shine1594/secrets-to-env-action@master
        with:
          secrets: ${{ toJSON(secrets) }}
          secrets_env: production
          prefix_prod: ""
          file_name_prod: .env

      # æ­¥éª¤ 8: å®‰è£…é¡¹ç›®ä¾èµ–
      - name: ğŸ“¡ å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          echo "å¼€å§‹å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install

      # æ­¥éª¤ 9: è¿è¡Œé¡¹ç›®ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ
      - name: ğŸš€ è¿è¡Œé¡¹ç›®
        uses: nick-fields/retry@master
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: |
            echo "å¼€å§‹è¿è¡Œé¡¹ç›®ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡è¶…æ—¶æ—¶é—´ä¸º 30 åˆ†é’Ÿ..."
            npm start

      # æ­¥éª¤ 10: å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡ç©ºæäº¤å¹¶æ¨é€ä»£ç 
      - name: ğŸš— ä¿æŒè¿è¡ŒçŠ¶æ€
        if: github.event_name == 'schedule'
        run: |
          echo "æœ¬æ¬¡å·¥ä½œæµç”±å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œè¿›è¡Œä¸€æ¬¡ç©ºæäº¤å¹¶æ¨é€ä»£ç ..."
          git config --local user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git remote set-url origin https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}
          git pull --rebase --autostash
          git commit --allow-empty -m "Keep Running..."
          git push

      # æ­¥éª¤ 11: åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•ï¼Œä¿ç•™æœ€æ–°çš„ 50 æ¡è®°å½•
      - name: ğŸ‰ åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 50
