name: Auto Green 2024 (1-3 Commits/Day)

on:
  workflow_dispatch:
    inputs:
      enable:
        description: "启用/禁用自动提交"
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # 每2小时尝试触发一次
    - cron: "0 */2 * * *"

jobs:
  auto-green:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' &&
        (
          "`expr ${{ github.run_number }} % 12`" == "0" ||
          "`expr ${{ github.run_number }} % 6`" == "0" ||
          "`expr ${{ github.run_number }} % 3`" == "0"
        )
      ) ||
      github.event_name == 'workflow_dispatch' && github.event.inputs.enable == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email ${{ secrets.EMAIL }}
          git config --local user.name ${{ secrets.NAME }}
          git remote set-url origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Generate random commits
        run: |
          set -e
          # 生成随机提交次数（1-3次）
          COMMIT_COUNT=$((RANDOM % 3 + 1))
          echo "Generating $COMMIT_COUNT commits today"

          # 获取当前UTC日期
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          echo "Current date: $CURRENT_DATE"

          # 生成随机提交时间
          for i in $(seq 1 $COMMIT_COUNT); do
              RANDOM_TIME=$(printf "%02d:%02d:%02d" $((RANDOM % 24)) $((RANDOM % 60)) $((RANDOM % 60)))
              DATETIME="$CURRENT_DATE $RANDOM_TIME"
              echo "Commit $i at $DATETIME"
              
              export GIT_COMMITTER_DATE="$DATETIME"
              export GIT_AUTHOR_DATE="$DATETIME"
              git commit --allow-empty -m "Daily green commit $i at $DATETIME"
          done

      - name: Push changes
        run: |
          git push --force
